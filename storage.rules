rules_version = '2';

/**
 * Firebase Storage Security Rules
 *
 * Purpose: Enforce team-isolated storage access
 * Structure: teams/{teamId}/projects/{projectId}/tasks/{taskId}/{mediaFile}
 *
 * Rules:
 * - Only authenticated users can access storage
 * - Users can only access files from their own teams
 * - File size limit: 10MB
 * - Allowed types: images (image/*) and videos (video/*)
 */

service firebase.storage {
  match /b/{bucket}/o {

    // Allow list on team/project paths (needed for deleteProjectMedia)
    match /teams/{teamId}/projects/{projectId}/{allPaths=**} {
      allow list: if request.auth != null;
    }

    // Team-isolated storage path
    match /teams/{teamId}/projects/{projectId}/tasks/{taskId}/{mediaFile} {
      // Allow authenticated users (team check via Firestore is complex)
      allow read, delete: if request.auth != null;

      // Upload with size limit (10MB)
      allow write: if request.auth != null &&
                      request.resource.size < 10 * 1024 * 1024;
    }

    // Deny all other paths by default
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
